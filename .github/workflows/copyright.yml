name: Copyright update

on:
    push:
#  schedule:
#    - cron: '00 03 1 1 * *'
#  To test:
#    - cron: '00 13 22 2 * *'

jobs:
  update-copyright:
    if: github.repository_owner == 'Kat-90'
#    if: github.repository_owner == 'metoppv'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:

    - name: Checkout repo
      uses: actions/checkout@v2

    - name: Configure git
      uses: cylc/release-actions/configure-git@v1

    - name: Checkout PR branch
      uses: cylc/release-actions/checkout-copyright-branch@v1
jobs:
  Update-Copyright-Date:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: update date
      run: |
        last_year=$(date --date='1 year ago' +%Y)
        this_year=$(date +"%Y")
        find . -type f -exec sed -i'' -e 's/2017-${last_year}/2017-${this_year}/g' {} +
    - name: Commit & push
      run : |
        git commit -a -m "Update copyright year" -m "Workflow: ${{ github.workflow }}, run: ${{ github.run_number }}"
        git push
    - name: Create pull request
      uses: cylc/release-actions/create-pr@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        head: ${{ env.BRANCH_NAME }}
        title: 'Auto PR: update copyright year'
        body:  |
            Update copyright dates
            - Updated to include the current year
            - Auto-generated by github actions
